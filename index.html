<!DOCTYPE html>
<html>

<head>
  <title>Auditory Perception Study</title>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="jspsych-6.2.0/jspsych.js"></script>
  <script type="text/javascript" src="lib/jspsych-pavlovia-3.0.0.js"></script>
  <script src="jspsych-6.2.0/plugins/jspsych-image-keyboard-response.js"></script>
  <script src="jspsych-6.2.0/plugins/jspsych-video-keyboard-response.js"></script>
  <script src="jspsych-6.2.0/plugins/jspsych-call-function.js"></script>
  <script src="jspsych-6.2.0/plugins/jspsych-audio-button-response.js"></script>
  <script src="jspsych-6.2.0/plugins/jspsych-audio-keyboard-response.js"></script>
  <script src="jspsych-6.2.0/plugins/jspsych-html-keyboard-response.js"></script>
  <script src="jspsych-6.2.0/plugins/jspsych-html-button-response.js"></script>
  <script src="jspsych-6.2.0/plugins/jspsych-html-slider-response.js"></script>
  <script src="jspsych-6.2.0/plugins/jspsych-survey-multi-choice.js"></script>
  <script src="jspsych-6.2.0/plugins/jspsych-survey-text.js"></script>
  <script src="jspsych-6.2.0/plugins/jspsych-fullscreen.js"></script>
  <script src="jspsych-6.2.0/plugins/jspsych-instructions.js"></script>
  <script src="jspsych-6.2.0/plugins/jspsych-external-html.js"></script>
  <script src="jspsych-6.2.0/plugins/jspsych-sentence-resp.js"></script>

  <script>
    //Assign the counterbalance version
    var counterbalance = Math.floor(Math.random() * 10) + 1 //this is the selected counterbalance version
    console.log("counterbalance version is...", counterbalance);


    jsPsych.data.addProperties({
      counterbalance: counterbalance
    }); //add subject id to data file
  </script>

  <script src="audcheck.js"></script>
  <script src="slTrain.js"></script>
  <script src="AFCtask.js"></script>
  <script src="CompletionTask.js"></script>

  <link href="jspsych-6.2.0/css/jspsych.css" rel="stylesheet" type="text/css">
</head>
<style>
  body {
    background-color: gray;
  }
</style>


<body>

  <script>
    //Participant Identifier
    var identifier = jsPsych.randomization.randomID(15); //random alphanumeric identifier
    jsPsych.data.addProperties({
      ParticipantID: identifier
    }); //random participant id to data

    //IMPORTANT VARIABLES//
    var timeline = []; //specify the jsPsych timeline to which all trials/blocks are pushed

    /********************/
    /** PAVLOVIA INIT **/
    /********************/

    //Open the connection with Pavlovia
    var pavlovia_init = {
      type: "pavlovia",
      command: "init"
    };

    timeline.push(pavlovia_init);




    /*************/
    /** CONSENT **/
    /*************/

    var LOI = {
      type: 'instructions',
      pages: [
        'Welcome to the study. On the next page, you will see the <b>Letter of Information</b>. Please read this document carefully before agreeing to participate in the study.',
        '<p>Please read this Letter of Information. When you are ready to continue, scroll to the bottom of the page and click "Next".</p><embed src="consent/LOI.pdf" width="800px" height="2100px" />'
      ],
      show_clickable_nav: true,
      allow_backward: false
    };

    timeline.push(LOI);


    //function to make sure consent box is clicked before proceeding
    var check_consent = function(elem) {
      if ($('#consent_checkbox').is(':checked')) {
        return true;
      } else {
        alert("If you wish to participate, you must check YES. If you do not consent, simply exit out of this tab.");
        return false;
      }
      return false;
    };


    //consent html should be in subfolder labeled 'consent'
    var consent_trial = {
      type: "external-html",
      url: "consent/consent.html",
      cont_btn: "start",
      check_fn: check_consent
    };

    timeline.push(consent_trial);


    /**************************/
    /** AUDITORY CALIBRATION **/
    /**************************/

    /*
    Loaded from audcheck.js

    This short auditory calibration involves
    a volume adjustment (in which participants
    must adjust their volume so a noise file
    is being played at a comfortable listening
    level). It also involves a short headphone
    assessment (Wood et al., 2017)

    The variable to push to the timeline is
    called audcheck, and the variable containing
    the sound files for preloading can be
    specified using the return_audcheck_folder()
    function
    */

    timeline.push(audcheck);
    var CALIB_SOUNDS = return_audcheck_folder(); //function from audcheck.js


    /*******************************/
    /** NON-SPEECH INDUCTION TASK***/
    /*******************************/
    /*

    Participants hear 64 sounds (all 16 syllables in both their 1-formant SWS form, and their 3-formant SWS form, presented twice).

    */



    var nonspeech_instruct = {
      type: 'instructions',
      pages: [
        'Welcome to the experiment. Click next to begin.',
        '<p>In this part of the study, you will listen to speech syllables (for example, "ta") produced by a human talker.</p><p>Each syllable will be followed by a heavily distorted version of itself, which may be difficult to understand. These syllables are considered a <b>matched pair</b> because the second syllable is a distorted version of the first syllable.</p><p>Listen carefully to each pair, as later you will be asked to identify whether the syllables are part of the same pair or not.</p><p>You will hear 16 pairs in total, each presented 2 times.</p>',
        'When you are ready to begin, please advance the screen by pressing the next button.'
      ],
      show_clickable_nav: true
    };



    var nonsp_timelinevars = [
    {sound1: 'sounds/syllables/ba_C.wav', sound2: 'sounds/syllables/ba_SWS.wav', syllable: 'bah'},
    {sound1: 'sounds/syllables/bi_C.wav', sound2: 'sounds/syllables/bi_SWS.wav', syllable: 'bee'},
    {sound1: 'sounds/syllables/da_C.wav', sound2: 'sounds/syllables/da_SWS.wav', syllable: 'dah'},
    {sound1: 'sounds/syllables/do_C.wav', sound2: 'sounds/syllables/do_SWS.wav', syllable: 'dough'},
    {sound1: 'sounds/syllables/gi_C.wav', sound2: 'sounds/syllables/gi_SWS.wav', syllable: 'gee'},
    {sound1: 'sounds/syllables/gu_C.wav', sound2: 'sounds/syllables/gu_SWS.wav', syllable: 'goo'},
    {sound1: 'sounds/syllables/ki_C.wav', sound2: 'sounds/syllables/ki_SWS.wav', syllable: 'kee'},
    {sound1: 'sounds/syllables/ku_C.wav', sound2: 'sounds/syllables/ku_SWS.wav', syllable: 'koo'},
    {sound1: 'sounds/syllables/le_C.wav', sound2: 'sounds/syllables/le_SWS.wav', syllable: 'lay'},
    {sound1: 'sounds/syllables/lo_C.wav', sound2: 'sounds/syllables/lo_SWS.wav', syllable: 'low'},
    {sound1: 'sounds/syllables/mo_C.wav', sound2: 'sounds/syllables/mo_SWS.wav', syllable: 'moe'},
    {sound1: 'sounds/syllables/mu_C.wav', sound2: 'sounds/syllables/mu_SWS.wav', syllable: 'moo'},
    {sound1: 'sounds/syllables/na_C.wav', sound2: 'sounds/syllables/na_SWS.wav', syllable: 'nah'},
    {sound1: 'sounds/syllables/ne_C.wav', sound2: 'sounds/syllables/ne_SWS.wav', syllable: 'nay'},
    {sound1: 'sounds/syllables/te_C.wav', sound2: 'sounds/syllables/te_SWS.wav', syllable: 'taye'},
    {sound1: 'sounds/syllables/tu_C.wav', sound2: 'sounds/syllables/tu_SWS.wav', syllable: 'too'}
    ];

//    nonsp_induction_timelinevars = jsPsych.randomization.repeat(nonsp_timelinevars, 5); //shuffle and double array size to make 24 trials

    var induction_play_nonspeech1 = {
      type: 'audio-keyboard-response',
      stimulus: jsPsych.timelineVariable('sound1'),
      choices: jsPsych.NO_KEYS,
      trial_duration: 1000
    };

    var induction_play_nonspeech2 = {
      type: 'audio-keyboard-response',
      stimulus: jsPsych.timelineVariable('sound2'),
      choices: jsPsych.NO_KEYS,
      trial_ends_after_audio: true
    };

    var transition = {
      type: 'html-button-response',
      stimulus: 'Press Enter to continue.',
      choices: ['Enter'],
      post_trial_gap: 500
    };


    var nonspeech_procedure = {
      timeline: [induction_play_nonspeech1, induction_play_nonspeech2, transition],
      timeline_variables: nonsp_timelinevars,
      randomize_order: true,
      repetitions: 2
    };

    var nonspeech_procedure_final = {
      timeline: [nonspeech_instruct, nonspeech_procedure]
    }




    timeline.push(nonspeech_procedure_final);


    //Phase 2 of Induction (testing)//
    //4 of the pairs don't match//


    var induction_test_timelinevars = [
      {sound1: 'sounds/syllables/ba_C.wav', sound2: 'sounds/syllables/ba_SWS.wav', syllable: 'bah', correct:0},
      {sound1: 'sounds/syllables/bi_C.wav', sound2: 'sounds/syllables/bi_SWS.wav', syllable: 'bee', correct:0},
      {sound1: 'sounds/syllables/da_C.wav', sound2: 'sounds/syllables/da_SWS.wav', syllable: 'dah', correct:0},
      {sound1: 'sounds/syllables/do_C.wav', sound2: 'sounds/syllables/do_SWS.wav', syllable: 'dough', correct:0},
      {sound1: 'sounds/syllables/gi_C.wav', sound2: 'sounds/syllables/gi_SWS.wav', syllable: 'gee', correct:0},
      {sound1: 'sounds/syllables/gu_C.wav', sound2: 'sounds/syllables/gu_SWS.wav', syllable: 'goo', correct:0},
      {sound1: 'sounds/syllables/ki_C.wav', sound2: 'sounds/syllables/ki_SWS.wav', syllable: 'kee', correct:0},
      {sound1: 'sounds/syllables/ku_C.wav', sound2: 'sounds/syllables/ku_SWS.wav', syllable: 'koo', correct:0},
      {sound1: 'sounds/syllables/le_C.wav', sound2: 'sounds/syllables/le_SWS.wav', syllable: 'lay', correct:0},
      {sound1: 'sounds/syllables/lo_C.wav', sound2: 'sounds/syllables/lo_SWS.wav', syllable: 'low', correct:0},
      {sound1: 'sounds/syllables/mo_C.wav', sound2: 'sounds/syllables/mo_SWS.wav', syllable: 'moe', correct:0},
      {sound1: 'sounds/syllables/mu_C.wav', sound2: 'sounds/syllables/mu_SWS.wav', syllable: 'moo', correct:0},
      {sound1: 'sounds/syllables/na_C.wav', sound2: 'sounds/syllables/na_SWS.wav', syllable: 'nah', correct:0},
      {sound1: 'sounds/syllables/ne_C.wav', sound2: 'sounds/syllables/ne_SWS.wav', syllable: 'nay', correct:0},
      {sound1: 'sounds/syllables/te_C.wav', sound2: 'sounds/syllables/te_SWS.wav', syllable: 'taye', correct:0},
      {sound1: 'sounds/syllables/tu_C.wav', sound2: 'sounds/syllables/tu_SWS.wav', syllable: 'too', correct:0},


      {sound1: 'sounds/syllables/ba_C.wav', sound2: 'sounds/syllables/ba_SWS.wav', syllable: 'bah', correct:0},
      {sound1: 'sounds/syllables/bi_C.wav', sound2: 'sounds/syllables/bi_SWS.wav', syllable: 'bee', correct:0},
      {sound1: 'sounds/syllables/da_C.wav', sound2: 'sounds/syllables/da_SWS.wav', syllable: 'dah', correct:0},
      {sound1: 'sounds/syllables/do_C.wav', sound2: 'sounds/syllables/do_SWS.wav', syllable: 'dough', correct:0},
      {sound1: 'sounds/syllables/gi_C.wav', sound2: 'sounds/syllables/gi_SWS.wav', syllable: 'gee', correct:0},
      {sound1: 'sounds/syllables/gu_C.wav', sound2: 'sounds/syllables/gu_SWS.wav', syllable: 'goo', correct:0},
      {sound1: 'sounds/syllables/ki_C.wav', sound2: 'sounds/syllables/ki_SWS.wav', syllable: 'kee', correct:0},
      {sound1: 'sounds/syllables/ku_C.wav', sound2: 'sounds/syllables/ku_SWS.wav', syllable: 'koo', correct:0},
      {sound1: 'sounds/syllables/le_C.wav', sound2: 'sounds/syllables/le_SWS.wav', syllable: 'lay', correct:0},
      {sound1: 'sounds/syllables/lo_C.wav', sound2: 'sounds/syllables/lo_SWS.wav', syllable: 'low', correct:0},
      {sound1: 'sounds/syllables/mo_C.wav', sound2: 'sounds/syllables/mo_SWS.wav', syllable: 'moe', correct:0},
      {sound1: 'sounds/syllables/mu_C.wav', sound2: 'sounds/syllables/mu_SWS.wav', syllable: 'moo', correct:0},
      {sound1: 'sounds/syllables/na_C.wav', sound2: 'sounds/syllables/na_SWS.wav', syllable: 'nah', correct:0},
      {sound1: 'sounds/syllables/ne_C.wav', sound2: 'sounds/syllables/ne_SWS.wav', syllable: 'nay', correct:0},
      {sound1: 'sounds/syllables/te_C.wav', sound2: 'sounds/syllables/te_SWS.wav', syllable: 'taye', correct:0},
      {sound1: 'sounds/syllables/tu_C.wav', sound2: 'sounds/syllables/tu_SWS.wav', syllable: 'too', correct:0},



      {sound1: 'sounds/syllables/ba_C.wav', sound2: 'sounds/syllables/ba_SWS.wav', syllable: 'bah', correct:0},
      {sound1: 'sounds/syllables/bi_C.wav', sound2: 'sounds/syllables/bi_SWS.wav', syllable: 'bee', correct:0},
      {sound1: 'sounds/syllables/da_C.wav', sound2: 'sounds/syllables/da_SWS.wav', syllable: 'dah', correct:0},
      {sound1: 'sounds/syllables/do_C.wav', sound2: 'sounds/syllables/do_SWS.wav', syllable: 'dough', correct:0},
      {sound1: 'sounds/syllables/gi_C.wav', sound2: 'sounds/syllables/gi_SWS.wav', syllable: 'gee', correct:0},
      {sound1: 'sounds/syllables/gu_C.wav', sound2: 'sounds/syllables/gu_SWS.wav', syllable: 'goo', correct:0},
      {sound1: 'sounds/syllables/ki_C.wav', sound2: 'sounds/syllables/ki_SWS.wav', syllable: 'kee', correct:0},
      {sound1: 'sounds/syllables/ku_C.wav', sound2: 'sounds/syllables/ku_SWS.wav', syllable: 'koo', correct:0},
      {sound1: 'sounds/syllables/le_C.wav', sound2: 'sounds/syllables/le_SWS.wav', syllable: 'lay', correct:0},
      {sound1: 'sounds/syllables/lo_C.wav', sound2: 'sounds/syllables/lo_SWS.wav', syllable: 'low', correct:0},
      {sound1: 'sounds/syllables/mo_C.wav', sound2: 'sounds/syllables/mo_SWS.wav', syllable: 'moe', correct:0},
      {sound1: 'sounds/syllables/mu_C.wav', sound2: 'sounds/syllables/mu_SWS.wav', syllable: 'moo', correct:0},
      {sound1: 'sounds/syllables/na_C.wav', sound2: 'sounds/syllables/na_SWS.wav', syllable: 'nah', correct:0},
      {sound1: 'sounds/syllables/ne_C.wav', sound2: 'sounds/syllables/ne_SWS.wav', syllable: 'nay', correct:0},
      {sound1: 'sounds/syllables/te_C.wav', sound2: 'sounds/syllables/te_SWS.wav', syllable: 'taye', correct:0},
      {sound1: 'sounds/syllables/tu_C.wav', sound2: 'sounds/syllables/tu_SWS.wav', syllable: 'too', correct:0},


      {sound1: 'sounds/syllables/ku_C.wav', sound2: 'sounds/syllables/le_SWS.wav', syllable: 'koo', correct:1},
      {sound1: 'sounds/syllables/ki_C.wav', sound2: 'sounds/syllables/mo_SWS.wav', syllable: 'kee', correct:1},
      {sound1: 'sounds/syllables/ne_C.wav', sound2: 'sounds/syllables/do_SWS.wav', syllable: 'nay', correct:1},
      {sound1: 'sounds/syllables/lo_C.wav', sound2: 'sounds/syllables/gi_SWS.wav', syllable: 'low', correct:1},
      {sound1: 'sounds/syllables/da_C.wav', sound2: 'sounds/syllables/te_SWS.wav', syllable: 'dah', correct:1}
    ];


        var nonspeech_procedure_2_instructions = {
          type: 'html-button-response',
          stimulus: "<p>You will now be tested on your knowledge of the pairs from the previous task.</p>" +
                  "<p>On each trial, you will be played two sounds. After hearing both sounds, you will be asked to indicate whether those two sounds are part of the same <b>matched pair</b> by pressing the corresponding button.</p>"+
                  "<p>There will be 53 trials in total.</p>", //make shorter?
          choices: ['Begin']
        };

        var induction_judgement = {
          type: 'html-button-response',
          stimulus: 'Were the two sounds a <b>matched pair</b>?',
          choices: ['Yes, they were a matched pair', 'No, they were not a matched pair'],
          data:
            {designation: 'induction',
            sound1: jsPsych.timelineVariable('sound1'),
            sound2: jsPsych.timelineVariable('sound2'),
            syllable: jsPsych.timelineVariable('syllable'),
            correctanswer: jsPsych.timelineVariable('correct')},
          on_finish: function(data) {
            var button_pressed = data.button_pressed;
            if (button_pressed == data.correctanswer) {
              data.correct = 1;
              feedback_text = '<p style="color:#054d00;"><b>Correct!</b></p>';
            } else {
              data.correct = 0;
              feedback_text = '<p style="color:#690000;"><b>Incorrect!</b></p>';
            }
          },
          post_trial_gap: 500,
          response_ends_trial: true
        };

        var induction_feedback = {
          type: 'html-keyboard-response',
          stimulus: function() {
            return feedback_text;
          },
          choices: jsPsych.NO_KEYS,
          trial_duration: 1000,
          post_trial_gap: 500
        };

        var nonspeech_procedure_2 = {
          timeline: [induction_play_nonspeech1, induction_play_nonspeech2, induction_judgement, induction_feedback],
          timeline_variables: induction_test_timelinevars,
          randomize_order: true
        };


        var nonspeech_procedure_2_final = {
          timeline: [nonspeech_procedure_2_instructions, nonspeech_procedure_2]
        }

        timeline.push(nonspeech_procedure_2_final);






    /**************************/
    /** SL TRAINING TASK **/
    /**************************/
    /*

    This is where participants are
    trained on the statistical
    language for 3 minutes.


    */


   timeline.push(slTrain);
    var SLTRAIN_SOUNDS = return_slTrain_folder();

    /***********************************/
    /***** Forced Choice Task *****/
    /***********************************/

    // FORCED CHOICE TASK //
    /*
    Here, participants are presented with either 2 or 4
    trisyllabic combinations and must determine which
    combination they think belongs to the language.

    There are 34 total trials (randomized):
    22 trials with 2 options (2-AFC)
    12 trials with 4 options (4-AFC)

    //Get the timeline variables (AFC_PROC_FINAL) and the audio string (return_AFC_sounds();) from AFCtask.js

    */

    timeline.push(RANDOMIZE_twofour_trials);
    var AFC_SOUNDS = return_AFC_sounds();


    /*********************************/
    /***** Completion Trials *****/
    /*********************************/
    /*
    This is the final of three assessments of learning.
    Participants listen to a pair or triplet, but with
    one syllable replaced with white noise. They are then
    presented with 3 syllables, and were asked to determine
    which syllable completed the missing pattern. There are 8 trials.


    //Get the timeline variables (COMPLETION_FINAL) and the audio string (completion_AUD) from targetDetection.js

    */

    timeline.push(COMPLETION_FINAL);
    var COMPLETION_SOUNDS = return_completion_sounds();
    var COMPLETION_IMAGES = return_completion_images();

    ///Extra Questions////
    var soundperception = {
      type: 'survey-text',
      questions: [{
        prompt: "During this study you heard streams of sounds. Please describe the sounds that you heard (e.g., alien sounds, robotic noises).",
        rows: 5,
        columns: 40
      }, ]
    };

    ///Add Additional Questions////
    var speech_followup_01 = {
      type: 'html-slider-response',
      stimulus: "<p>Using the slider, please indicate how often you perceived the streams of sounds as containing syllables that sound like those found in speech (e.g. 'ta' or 'me')</p><p>(1 corresponds to <em>the sounds <b>never</b> sounded like syllables found in speech</em>)</p><p>(10 corresponds to <em>the sounds <b>always</b> sounded like syllables found in speech)</em></p>",
      min: 1,
      max: 10,
      slider_start: 5,
      labels: ["1", "2", "3", "4", "5", "6", "7", "8", "9", "10"],
      data: {designation: 'q-soundlikespeech-slider'}
    };


    var speech_followup_02 = {
      type: 'survey-multi-choice',
      questions: [
      {
      prompt: "At what point during the study did you begin to perceive the stream as containing speech-like syllables?",
      name: 'timecourseSpeech',
      options: ["<b>During the first task:</b> When judging whether two sounds were a <b>matched pair</b>",  "<b>During the second task:</b> When listening to the stream of sounds for 3 minutes", "<b>During the third task:</b> When comparing a series of sounds and choosing which ones were most familiar", "<b>During the fourth task:</b> When deciding which sounds completed the missing sections of the patterns presented", "I never heard the sounds as speech."],
      required: false
    }],
    data: {designation: 'q-soundlikespeech-timecourse'}
  };

    var transcription_instruct = {
      type: 'html-button-response',
      stimulus: "In this part of the study, you will listen to short sounds. You will then be asked if each sound was speech-like or not.",
      choices: ['Begin']
    };

    var transcription_timelinevars = [{
        sounds: 'sounds/syllables/ba_SWS.wav',
        syllable: 'BAH',
        syllable_type: 'sinewave'
      },
      {
        sounds: 'sounds/syllables/bi_SWS.wav',
        syllable: 'BEE',
        syllable_type: 'sinewave'
      },
      {
        sounds: 'sounds/syllables/da_SWS.wav',
        syllable: 'DAH',
        syllable_type: 'sinewave'
      },
      {
        sounds: 'sounds/syllables/do_SWS.wav',
        syllable: 'DOUGH',
        syllable_type: 'sinewave'
      },
      {
        sounds: 'sounds/syllables/gi_SWS.wav',
        syllable: 'GEE',
        syllable_type: 'sinewave'
      },
      {
        sounds: 'sounds/syllables/gu_SWS.wav',
        syllable: 'GOO',
        syllable_type: 'sinewave'
      },
      {
        sounds: 'sounds/syllables/ki_SWS.wav',
        syllable: 'KEY',
        syllable_type: 'sinewave'
      },
      {
        sounds: 'sounds/syllables/ku_SWS.wav',
        syllable: 'KOO',
        syllable_type: 'sinewave'
      },
      {
        sounds: 'sounds/syllables/le_SWS.wav',
        syllable: 'LAY',
        syllable_type: 'sinewave'
      },
      {
        sounds: 'sounds/syllables/lo_SWS.wav',
        syllable: 'LOW',
        syllable_type: 'sinewave'
      },
      {
        sounds: 'sounds/syllables/mo_SWS.wav',
        syllable: 'MOE',
        syllable_type: 'sinewave'
      },
      {
        sounds: 'sounds/syllables/mu_SWS.wav',
        syllable: 'MOO',
        syllable_type: 'sinewave'
      },
      {
        sounds: 'sounds/syllables/na_SWS.wav',
        syllable: 'NAH',
        syllable_type: 'sinewave'
      },
      {
        sounds: 'sounds/syllables/ne_SWS.wav',
        syllable: 'NAY',
        syllable_type: 'sinewave'
      },
      {
        sounds: 'sounds/syllables/te_SWS.wav',
        syllable: 'TAY',
        syllable_type: 'sinewave'
      },
      {
        sounds: 'sounds/syllables/tu_SWS.wav',
        syllable: 'TOO',
        syllable_type: 'sinewave'
      },
    ];

    var transcription_play = {
      type: 'audio-keyboard-response',
      stimulus: jsPsych.timelineVariable('sounds'),
      choices: jsPsych.NO_KEYS,
      trial_ends_after_audio: true
    };

    var heardasspeech; //toggle this depending on response

    var transcription_judgement = {
      type: 'html-button-response',
      stimulus: 'Did you hear the sound as speech-like?',
      choices: ['No', 'Yes'],
      data: {
        designation: 'TRANSCRIPTION-JUDGE',
        syllable: jsPsych.timelineVariable('syllable'),
        syllable_type: jsPsych.timelineVariable('syllable_type')
      },
      on_finish: function(data) {
        heardasspeech = data.button_pressed
      }
    };

    var transcription_followup = {
      type: 'survey-text',
      questions: [{
        prompt: "Please type out the sound that you heard to the best of your ability.",
        rows: 2,
        columns: 20
      }, ],
      data: {
        designation: 'TRANSCRIPTION-FOLLOWUP',
        syllable: jsPsych.timelineVariable('syllable'),
        syllable_type: jsPsych.timelineVariable('syllable_type')
      }
    };

    var followup_proc = {
      timeline: [transcription_followup],
      conditional_function: function() {
        if (heardasspeech) {
          return true;
        } else {
          return false
        }
      }
    };

    var fiaxtion = {
      type: 'html-keyboard-response',
      stimulus: '<p style="font-size:40px;">+</p>',
      trial_duration: 1000
    };

    var transcription_procedure = {
      timeline: [transcription_play, transcription_judgement, followup_proc, fixation],
      timeline_variables: transcription_timelinevars,
      randomize_order: true
    };

    var transcription_procedure_final = {
      timeline: [soundperception, speech_followup_01, speech_followup_02, transcription_instruct, transcription_procedure]
    };

    timeline.push(transcription_procedure_final);



    //transcription of normal, non-SWS syllables

    var transcription_normal_timelinevars = [{
        sounds: 'sounds/syllables/ba_C.wav',
        syllable: 'BAH',
        syllable_type: 'non-sinewave'
      },
      {
        sounds: 'sounds/syllables/bi_C.wav',
        syllable: 'BEE',
        syllable_type: 'non-sinewave'
      },
      {
        sounds: 'sounds/syllables/da_C.wav',
        syllable: 'DAH',
        syllable_type: 'non-sinewave'
      },
      {
        sounds: 'sounds/syllables/do_C.wav',
        syllable: 'DOUGH',
        syllable_type: 'non-sinewave'
      },
      {
        sounds: 'sounds/syllables/gi_C.wav',
        syllable: 'GEE',
        syllable_type: 'non-sinewave'
      },
      {
        sounds: 'sounds/syllables/gu_C.wav',
        syllable: 'GOO',
        syllable_type: 'non-sinewave'
      },
      {
        sounds: 'sounds/syllables/ki_C.wav',
        syllable: 'KEE',
        syllable_type: 'non-sinewave'
      },
      {
        sounds: 'sounds/syllables/ku_C.wav',
        syllable: 'KOO',
        syllable_type: 'non-sinewave'
      },
      {
        sounds: 'sounds/syllables/le_C.wav',
        syllable: 'LAY',
        syllable_type: 'non-sinewave'
      },
      {
        sounds: 'sounds/syllables/lo_C.wav',
        syllable: 'LOW',
        syllable_type: 'non-sinewave'
      },
      {
        sounds: 'sounds/syllables/mo_C.wav',
        syllable: 'MOE',
        syllable_type: 'non-sinewave'
      },
      {
        sounds: 'sounds/syllables/mu_C.wav',
        syllable: 'MOO',
        syllable_type: 'non-sinewave'
      },
      {
        sounds: 'sounds/syllables/na_C.wav',
        syllable: 'NAH',
        syllable_type: 'non-sinewave'
      },
      {
        sounds: 'sounds/syllables/ne_C.wav',
        syllable: 'NAY',
        syllable_type: 'non-sinewave'
      },
      {
        sounds: 'sounds/syllables/te_C.wav',
        syllable: 'TAY',
        syllable_type: 'non-sinewave'
      },
      {
        sounds: 'sounds/syllables/tu_C.wav',
        syllable: 'TOO',
        syllable_type: 'non-sinewave'
      },
    ];


    var transcription_procedure_normal = {
      timeline: [transcription_play, transcription_judgement, followup_proc, fixation],
      timeline_variables: transcription_normal_timelinevars,
      randomize_order: true
    }

    timeline.push(transcription_procedure_normal);




            /****************************/
            /** SWS SENTENCE INDUCTION **/
            /****************************/
            /*

            This is meant to further encourage participants in the
            speech condition to hear the sinewave manipulation as
            speech.

            */
            //get non-attenuated version of sentences

            var sentence_sws_speech_instruct = {
              type: 'html-button-response',
              stimulus: '<p>Thank you for your answers.</p><p>You will now listen to longer robotic sounds, similar as to before.</p>'+
                        '<p>Please listen carefully to each sound sequence. After each one, you will be asked to type back what you heard to the best of your ability. After you provide your response, you will be given feedback about the correct answer.</p>'+
                        '<p>There are 10 trials in total.',
              choices: ['Begin'],
              post_trial_gap: 500
            };

            var sws_sentence_tlinevars = [
              {
                sound_speech: 'sounds/sentences/14_01_cfSWS.mp3',
                speechCorrect: 'A cramp is no small danger on a swim.',
                keywords: ['cramp','no','small','danger','swim']
              },
              {
                sound_speech: 'sounds/sentences/14_02_cfSWS.mp3',
                speechCorrect: 'He said the same phrase thirty times.',
                keywords: ['said','same','phrase','thirty','times']
              },
              {
                sound_speech: 'sounds/sentences/14_03_cfSWS.mp3',
                speechCorrect: 'Pluck the bright rose without leaves.',
                keywords: ['pluck','bright','rose','without','leaves']
              },
              {
                sound_speech: 'sounds/sentences/14_04_cfSWS.mp3',
                speechCorrect: 'Two plus seven is less than ten.',
                keywords: ['two','plus','seven','less','ten']
              },
              {
                sound_speech: 'sounds/sentences/14_05_cfSWS.mp3',
                speechCorrect: 'The glow deepened in the eyes of the sweet girl.',
                keywords: ['glow','deepened','eyes','sweet','girl']
              },
              {
                sound_speech: 'sounds/sentences/14_06_cfSWS.mp3',
                speechCorrect: 'Bring your problems to the wise chief.',
                keywords: ['bring','your','problems','wise','chief']
              },
              {
                sound_speech: 'sounds/sentences/14_07_cfSWS.mp3',
                speechCorrect: 'Write a fond note to the friend you cherish.',
                keywords: ['write','fond','note','friend','cherish']
              },
              {
                sound_speech: 'sounds/sentences/14_08_cfSWS.mp3',
                speechCorrect: 'Clothes and lodging are free to new men.',
                keywords: ['clothes','lodging','free','new','men']
              },
              {
                sound_speech: 'sounds/sentences/14_09_cfSWS.mp3',
                speechCorrect: 'We frown when events take a bad turn.',
                keywords: ['frown','events','take','bad','turn']
              },
              {
                sound_speech: 'sounds/sentences/14_10_cfSWS.mp3',
                speechCorrect: 'Port is a strong wine with a smoky taste.',
                keywords: ['port','strong','wine','smoky','taste']
              }
            ];


            //functions for calculating sums and means of arrays
            const arrSum = arr => arr.reduce((a,b) => a + b, 0)
            const arrAvg = arr => arr.reduce((a,b) => a + b, 0) / arr.length

        var sentence_response_sws = {
            type: 'sentence-resp',
            questions: [{prompt: "", value: "", rows: 2, columns: 75}],
            post_trial_gap: 250,
            data: {sentence: jsPsych.timelineVariable('speechCorrect'), keywords: jsPsych.timelineVariable('keywords'), designation: 'SWS-SENT-RESPONSE'},
            preamble: "<p><b>Please click on the response box and then type back what you heard.</b></br>Do not worry about capitalization or punctuation. Please try your best to spell as accurately as possible.</p>",
            	on_finish: function(data){
            		var answer = JSON.parse(jsPsych.data.get().last(1).values()[0].responses).Q0; //this is the extracted string they typed
            		var correctANS = data.keywords; //this is the array of keywords

            		//Preprocess the responses (remove punctuation, spaces etc)
            		var answerNew = answer.split('.').join(""); //remove period punctuation
            		answerNew = answerNew.split(',').join(""); //remove comma punctuation
            		answerNew = answerNew.split('!').join(""); //remove exclamation punctuation
            		answerNew = answerNew.split('?').join(""); //remove question punctuation
            		answerNew = answerNew.toUpperCase(); //standardize capitalization
            		answerNew = answerNew.replace(/(\r\n|\n|\r)/gm, " "); //remove all line breaks
            		//Convert to uppercase
            		var correctUPPER= [];
            		for (i=0; i < correctANS.length; i++){
            			correctUPPER[i] = correctANS[i].toUpperCase();
            		}

            		var answer_parsed = answerNew.split(" "); //split typed-in answer based on space
            		var anstester = [0,0,0,0,0]; //array for storing correct answers....if there is a match, the 0 is changed to a 1

            		for (i = 0; i < answer_parsed.length; i++) {
            			var cur = answer_parsed[i];
            			for (j = 0; j < correctUPPER.length; j++) {
            				var key = correctUPPER[j];
            				if(cur == key) {
            					anstester[j] = 1;
            					correctUPPER[j] = null; //removes the answer so it cannot be counted twice
            				}
            			}
            		}

            		var totalCorrect = arrSum(anstester); //0-5 value for number of keywords identified
            		var propCorrect = arrAvg(anstester); //0-1 value for proportion of words on the trial

            		//Add these processed answers to the data output
            		jsPsych.data.addDataToLastTrial({
            			typed_resp: answerNew,
            			keyword1_acc: anstester[0],
            			keyword2_acc: anstester[1],
            			keyword3_acc: anstester[2],
            			keyword4_acc: anstester[3],
            			keyword5_acc: anstester[4],
            			total_acc: totalCorrect,
            			prop_acc: propCorrect
            		});
            	}
            };

            var induction_play_speech = {
              type: 'audio-keyboard-response',
              stimulus: jsPsych.timelineVariable('sound_speech'),
              choices: jsPsych.NO_KEYS,
              trial_ends_after_audio: true
            };

            var sentence_sws_feedback_pre = {
              type: 'html-keyboard-response',
              prompt: jsPsych.timelineVariable('speechCorrect'),
              stimulus: '',
              trial_duration: 1000,
              choices: jsPsych.NO_KEYS
            };

            var sentence_sws_feedback_post = {
              type: 'html-keyboard-response',
              prompt: jsPsych.timelineVariable('speechCorrect'),
              stimulus: '',
              trial_duration: 1000,
              choices: jsPsych.NO_KEYS,
              post_trial_gap: 500
            };

            var sentence_sws_feedback_play = {
              type: 'audio-keyboard-response',
              prompt: jsPsych.timelineVariable('speechCorrect'),
              stimulus: jsPsych.timelineVariable('sound_speech'),
              choices: jsPsych.NO_KEYS,
              trial_ends_after_audio: true
            };

            var sws_sent_interim = {
              type:'html-button-response',
              stimulus: '<p>Press the button below when you are ready to continue.</p>',
              choices: ['Continue'],
              post_trial_gap: 500
            };

            var sentence_sws_speech_proc = {
              timeline: [induction_play_speech, sentence_response_sws, sentence_sws_feedback_pre, sentence_sws_feedback_play, sentence_sws_feedback_post, sws_sent_interim],
              timeline_variables: sws_sentence_tlinevars,
              randomize_order: true
            };

            var sentence_sws_speech_final = {
              timeline: [sentence_sws_speech_instruct, sentence_sws_speech_proc]
            };

            var sws_sentence_preload = [];

            //push relevant sound files to a preload folder depending on condition
            for(var i=0; i<sws_sentence_tlinevars.length; i++){
                sws_sentence_preload.push(sws_sentence_tlinevars[i].sound_speech);
            };

             timeline.push(sentence_sws_speech_final)


    /*************/
    /** Wrap-Up **/
    /*************/

    //Save the Data
    var backup_data = {
      type: 'html-keyboard-response',
      stimulus: '<p>Saving your results...</p>',
      choices: jsPsych.NO_KEYS,
      trial_duration: 1000,
      on_finish: function() {
        var csvData = jsPsych.data.get().csv(); //this is the csv data
        console.log(csvData);
        var formData = {
          exp: "SL_SWS_EXP2_NONSPEECH",
          subj: identifier,
          results: csvData
        };
        $.post(
          "https://svanhedger.pythonanywhere.com/data",
          formData
        );
      }
    };

    timeline.push(backup_data);

    /********************/
    /** PAVLOVIA CLOSE **/
    /********************/

    //Close the connection to Pavlovia
    var pavlovia_close = {
      type: "pavlovia",
      command: "finish"
    };

    timeline.push(pavlovia_close);


    //Final Landing Page
    var surveylink = "https://uwo.eu.qualtrics.com/jfe/form/SV_8IHJT4EMXrvSKbA?SUBJID=" + identifier + "&id=%SURVEY_CODE%"; //survey link that includes participant ID //do this

    var final_page = {
      type: 'html-keyboard-response',
      stimulus: '<p>Thank you for your answers. This concludes the main part of the study.</p>' +
        '<p>The final part of the study is a short questionnaire.</p><p>Please click on the link below to be redirected to the questionnaire.</p>' +
        '<p><a href=' + surveylink + '>Start Survey</a>',
      choices: jsPsych.NO_KEYS
    };

    timeline.push(final_page);


    /*******************/
    /** PRELOAD FILES **/
    /*******************/



    var SYLLABLES = [
      'sounds/syllables/ba_SWS.wav', 'sounds/syllables/bi_SWS.wav', 'sounds/syllables/da_SWS.wav',
      'sounds/syllables/do_SWS.wav', 'sounds/syllables/gi_SWS.wav', 'sounds/syllables/gu_SWS.wav',
      'sounds/syllables/ki_SWS.wav', 'sounds/syllables/ku_SWS.wav', 'sounds/syllables/le_SWS.wav',
      'sounds/syllables/lo_SWS.wav', 'sounds/syllables/mo_SWS.wav', 'sounds/syllables/mu_SWS.wav',
      'sounds/syllables/na_SWS.wav', 'sounds/syllables/ne_SWS.wav', 'sounds/syllables/te_SWS.wav',
      'sounds/syllables/tu_SWS.wav',
      'sounds/syllables/ba_C.wav', 'sounds/syllables/bi_C.wav', 'sounds/syllables/da_C.wav',
      'sounds/syllables/do_C.wav', 'sounds/syllables/gi_C.wav', 'sounds/syllables/gu_C.wav',
      'sounds/syllables/ki_C.wav', 'sounds/syllables/ku_C.wav', 'sounds/syllables/le_C.wav',
      'sounds/syllables/lo_C.wav', 'sounds/syllables/mo_C.wav', 'sounds/syllables/mu_C.wav',
      'sounds/syllables/na_C.wav', 'sounds/syllables/ne_C.wav', 'sounds/syllables/te_C.wav',
      'sounds/syllables/tu_C.wav',
    ];

    var aud_preload = [...CALIB_SOUNDS, ...COMPLETION_SOUNDS, ...AFC_SOUNDS, ...SYLLABLES, ...AFC_SOUNDS, ...sws_sentence_preload]; //this is the final variable for preloading
    var img_preload = [COMPLETION_IMAGES];
//preload iamges here?
    jsPsych.init({
      timeline: timeline,
      preload_audio: aud_preload,
      preload_images: img_preload,
      override_safe_mode: true
    });
  </script>
</body>

</html>
